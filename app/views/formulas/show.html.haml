- title "#{@formula.pinyin}/ #{@formula.chinese} / #{@formula.english}#{@formula.state_board ? " (CALE)" : ""}"
%br/
!= tag_list @formula.tags

%table{'border' => '1', 'cellpadding' => "0", "cellspacing" => "0"}
  %tr
    %td{'valign' => 'top', 'align' => 'center', 'width' => '340px'}
      %h1!= @formula.pinyin
      %h1!= @formula.chinese if @formula.chinese
      %b "#{@formula.english}"
      %b!= "<br/>Variant of #{link_to @formula.master_formula.pinyin, @formula.master_formula}" if @formula.master_formula
    %td
      %h3= @formula.formula_category_list
      %br/
      - unless @formula.citation.nil?
        Reference: #{render :partial => 'citations/show', :locals => {:citation => @formula.citation}}
      - unless @formula.source_text_citation.nil?
        %br/
        Source Text: #{render :partial => 'citations/show', :locals => {:citation => @formula.source_text_citation}}
  %tr
    %td
      %b Therapeutic Actions:
      - @formula.formula_therapeutic_functions.each do |formula_therapeutic_function|
        .child= formula_therapeutic_function.therapeutic_function_name
    %td{'valign' => 'top'}
      - if (a = @formula.chief_herbs)
        %h3!= "Chief Herb#{'s' unless a.size==1}: #{a.map{|v| link_to_herb(v.herb)}.join(", ")}"
        %br/
      - unless @formula.patterns.empty?
        - p = @formula.patterns.first
        != "Keys: #{link(p.key_pattern_symptoms)}" unless p.key_pattern_symptoms.size==0
  - @formula.patterns.each do |p|
    - p = formula_pattern.pattern
    %tr
      %td{'valign' => 'top'}
        %b Diagnosis:
        #{link_to p.name, p}
        %p #{show_citation p.citation}
      %td{'valign' => 'top'}
        %b Indications:
        != link(p.pattern_symptoms)

%h2 Herbs
%table#formula_herbs{'border' => '1', 'cellpadding' => "0", "cellspacing" => "0"}
  - Formula::ROLES.each do |role|
    = render :partial => "show_formula_herbs", :locals => { :formula_herbs => @formula.formula_herbs.select{|a| a.formula_role.pinyin == role}, :show_roles => !@formula.chief_herbs.nil? }
- unless @formula.preparation.empty?
  .preparation
    %b Preparation:
    :tcmtextile
      #{@formula.preparation}

%h3 Commentary
%br/


- @formula.formula_patterns.each do |formula_pattern|
  - unless formula_pattern.commentary.blank?
    .commentary
      %b= formula_pattern.pattern_name
      :tcmtextile
        #{formula_pattern.commentary}

:tcmtextile
  #{@formula.commentary}

- if @formula.formula_contraindications.size > 0
  %h3 Cautions and Contraindications
  - @formula.formula_contraindications.each do |formula_contraindication|
    .child= formula_contraindication.contraindication_name

- if @formula.dui_yaos.size > 0
  %h2 Dui Yao's
  #dui_yaos
    - @formula.dui_yaos.each do |fdy|
      %b!= "#{link_to_herb fdy.herb1} and #{link_to_herb fdy.herb2}"
      %br/
      :tcmtextile
        bq.. #{fdy.commentary}

- if (a = @formula.all_comparisons).size > 0
  %h2 Comparisons
  %br/
  - a.each do |formula_comparison|
    %h3!= "vs #{link_to formula_comparison.other_formula(@formula).pinyin, formula_comparison.other_formula(@formula)}"
    %table.formula_comparison
      %tr
        %td Both Formulas
        %td
          :tcmtextile
            #{formula_comparison.commentary}
      %tr
        %td= formula_comparison.formula1.pinyin
        %td
          :tcmtextile
            #{formula_comparison.formula1_commentary}
      %tr
        %td= formula_comparison.formula2.pinyin
        %td
          :tcmtextile
            #{formula_comparison.formula2_commentary}

- if @formula.variations.size > 0
  %h3 Variations
  %ul
    - @formula.variations.each do |t|
      %li= link_to t.pinyin, t

- if can? :update, @formula
  = link_to 'Edit', edit_formula_path(@formula)
  = link_to "Edit Next: #{@next.pinyin}", "#{edit_formula_path(@next)}/?tags=#{@taglist}" unless @next.nil?
- link_to 'Back', formulas_path

