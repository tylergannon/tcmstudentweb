jQuery.fn.tabOverride=(function($){var aTab='\t';function overrideKeyDown(e){var tab,tabLen,text,range,tempRange,preNewlines,selNewlines,initScrollTop,selStart,selEnd,sel,startLine,endLine,numTabs,startTab,preTab;if(e.keyCode===9){tab=aTab;tabLen=tab.length;text=this.value;initScrollTop=this.scrollTop;numTabs=0;startTab=0;preTab=0;if(typeof this.selectionStart!=='undefined'){selStart=this.selectionStart;selEnd=this.selectionEnd;sel=text.slice(selStart,selEnd);}else if(document.selection){range=document.selection.createRange();sel=range.text;tempRange=range.duplicate();tempRange.moveToElementText(this);tempRange.setEndPoint('EndToEnd',range);selEnd=tempRange.text.length;selStart=selEnd-sel.length;preNewlines=text.slice(0,selStart).split('\r\n').length-1;selNewlines=sel.split('\r\n').length-1;}else{return;}
if(selStart!==selEnd&&sel.indexOf('\n')!==-1){if(selStart===0||text.charAt(selStart-1)==='\n'){startLine=selStart;}else{startLine=text.lastIndexOf('\n',selStart-1)+1;}
if(selEnd===text.length||text.charAt(selEnd)==='\n'){endLine=selEnd;}else{endLine=text.indexOf('\n',selEnd);if(endLine===-1){endLine=text.length;}}
if(e.shiftKey){if(text.slice(startLine).indexOf(tab)===0){if(startLine===selStart){sel=sel.slice(tabLen);}else{preTab=tabLen;}
startTab=tabLen;}
this.value=text.slice(0,startLine)+text.slice(startLine+preTab,selStart)+
sel.replace(new RegExp('\n'+tab,'g'),function(){numTabs+=1;return'\n';})+text.slice(selEnd);if(range){range.collapse();range.moveEnd('character',selEnd-startTab-(numTabs*tabLen)-selNewlines-preNewlines);range.moveStart('character',selStart-preTab-preNewlines);range.select();}else{this.selectionStart=selStart-preTab;this.selectionEnd=selEnd-startTab-(numTabs*tabLen);}}else{numTabs=1;this.value=text.slice(0,startLine)+tab+text.slice(startLine,selStart)+
sel.replace(/\n/g,function(){numTabs+=1;return'\n'+tab;})+text.slice(selEnd);if(range){range.collapse();range.moveEnd('character',selEnd+(numTabs*tabLen)-selNewlines-preNewlines);range.moveStart('character',selStart+tabLen-preNewlines);range.select();}else{this.selectionStart=selStart+tabLen;this.selectionEnd=selEnd+(numTabs*tabLen);}}}else{if(e.shiftKey){if(text.slice(selStart-tabLen).indexOf(tab)===0){this.value=text.slice(0,selStart-tabLen)+text.slice(selStart);if(range){range.move('character',selStart-tabLen-preNewlines);range.select();}else{this.selectionEnd=this.selectionStart=selStart-tabLen;}}}else{if(range){if(text.charAt(selStart)==='\r'){this.value=text.slice(0,selStart+2)+tab+text.slice(selEnd+2);range.move('character',selStart+1+tabLen-preNewlines);}else{this.value=text.slice(0,selStart)+tab+text.slice(selEnd);range.move('character',selStart+tabLen-preNewlines);}
range.select();}else{this.value=text.slice(0,selStart)+tab+text.slice(selEnd);this.selectionEnd=this.selectionStart=selStart+tabLen;}}}
this.scrollTop=initScrollTop;e.preventDefault();}}
function overrideKeyPress(e){if(e.keyCode===9){e.preventDefault();}}
function tabOverride(enable){this.each(function(){$(this).unbind('.tabOverride');});if(enable||typeof enable==='undefined'){this.each(function(){if(this.nodeName&&this.nodeName.toLowerCase()==='textarea'){$(this).bind('keydown.tabOverride',overrideKeyDown).bind('keypress.tabOverride',overrideKeyPress);}});}
return $(this);}
tabOverride.getTabSize=function(){return aTab==='\t'?0:aTab.length;};tabOverride.setTabSize=function(size){var i;if(!size){aTab='\t';}else if(typeof size==='number'&&size>0){aTab='';for(i=0;i<size;i+=1){aTab+=' ';}}};return tabOverride;}(jQuery));

